package com.github.se.studentconnect.ui.screen.profile

import androidx.compose.ui.test.*
import androidx.compose.ui.test.junit4.createComposeRule
import androidx.test.ext.junit.runners.AndroidJUnit4
import com.github.se.studentconnect.model.activities.Invitation
import com.github.se.studentconnect.model.friends.FriendsRepository
import com.github.se.studentconnect.model.user.User
import com.github.se.studentconnect.model.user.UserRepository
import com.github.se.studentconnect.ui.profile.ProfileScreenViewModel
import kotlinx.coroutines.delay
import kotlinx.coroutines.flow.Flow
import org.junit.Before
import org.junit.Rule
import org.junit.Test
import org.junit.runner.RunWith

@RunWith(AndroidJUnit4::class)
class ProfileScreenAndroidTest {

  @get:Rule val composeTestRule = createComposeRule()

  private lateinit var mockUserRepository: MockUserRepository
  private lateinit var mockFriendsRepository: MockFriendsRepository
  private lateinit var mockEventRepository: MockEventRepository
  private lateinit var testUser: User

  @Before
  fun setUp() {
    testUser =
        User(
            userId = "test123",
            username = "testuser",
            firstName = "John",
            lastName = "Doe",
            email = "john@test.com",
            university = "EPFL",
            country = "Switzerland",
            bio = "Test bio")

    mockUserRepository = MockUserRepository(testUser)
    mockFriendsRepository = MockFriendsRepository(listOf("friend1", "friend2", "friend3"))
    mockEventRepository = MockEventRepository()
  }

  @Test
  fun profileScreen_displaysUserInformation() {
    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId)

    composeTestRule.setContent {
      ProfileScreen(currentUserId = testUser.userId, viewModel = viewModel)
    }

    composeTestRule.waitForIdle()

    // Verify user name
    composeTestRule.onNodeWithText("John Doe").assertIsDisplayed()

    // Verify bio
    composeTestRule.onNodeWithText("Test bio").assertIsDisplayed()

    // Verify university
    composeTestRule.onNodeWithText("EPFL").assertIsDisplayed()

    // Verify country
    composeTestRule.onNodeWithText("Switzerland").assertIsDisplayed()
  }

  @Test
  fun profileScreen_displaysFriendsAndEventsCount() {
    mockFriendsRepository.friendsList = listOf("f1", "f2", "f3", "f4", "f5")
    mockUserRepository.joinedEvents = listOf("e1", "e2", "e3")

    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId)

    composeTestRule.setContent {
      ProfileScreen(currentUserId = testUser.userId, viewModel = viewModel)
    }

    composeTestRule.waitForIdle()

    // Verify friends count
    composeTestRule.onNodeWithText("5").assertIsDisplayed()
    composeTestRule.onNodeWithText("Friends").assertIsDisplayed()

    // Verify events count
    composeTestRule.onNodeWithText("3").assertIsDisplayed()
    composeTestRule.onNodeWithText("Events").assertIsDisplayed()
  }

  @Test
  fun profileScreen_displaysEditButton() {
    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId)

    composeTestRule.setContent {
      ProfileScreen(
          currentUserId = testUser.userId,
          viewModel = viewModel,
          navigationCallbacks = ProfileNavigationCallbacks(onNavigateToSettings = {}))
    }

    composeTestRule.waitForIdle()
    composeTestRule.onNodeWithText("Edit").assertIsDisplayed()
  }

  @Test
  fun profileScreen_displaysUserCardButton() {
    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId)

    composeTestRule.setContent {
      ProfileScreen(
          currentUserId = testUser.userId,
          viewModel = viewModel,
          navigationCallbacks = ProfileNavigationCallbacks(onNavigateToUserCard = {}))
    }

    composeTestRule.waitForIdle()
    composeTestRule.onNodeWithText("Card").assertIsDisplayed()
  }

  @Test
  fun profileScreen_editButtonTriggersNavigation() {
    var navigateToSettingsCalled = false

    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId)

    composeTestRule.setContent {
      ProfileScreen(
          currentUserId = testUser.userId,
          viewModel = viewModel,
          navigationCallbacks =
              ProfileNavigationCallbacks(
                  onNavigateToSettings = { navigateToSettingsCalled = true }))
    }

    composeTestRule.waitForIdle()
    composeTestRule.onNodeWithText("Edit").performClick()

    assert(navigateToSettingsCalled)
  }

  @Test
  fun profileScreen_userCardButtonTriggersNavigation() {
    var navigateToUserCardCalled = false

    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId)

    composeTestRule.setContent {
      ProfileScreen(
          currentUserId = testUser.userId,
          viewModel = viewModel,
          navigationCallbacks =
              ProfileNavigationCallbacks(
                  onNavigateToUserCard = { navigateToUserCardCalled = true }))
    }

    composeTestRule.waitForIdle()
    composeTestRule.onNodeWithText("Card").performClick()

    assert(navigateToUserCardCalled)
  }

  @Test
  fun profileScreen_displaysProfilePicturePlaceholder() {
    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId)

    composeTestRule.setContent {
      ProfileScreen(currentUserId = testUser.userId, viewModel = viewModel)
    }

    composeTestRule.waitForIdle()
    composeTestRule.onNodeWithContentDescription("Profile Picture").assertIsDisplayed()
  }

  @Test
  fun profileScreen_displaysLocationIcon() {
    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId)

    composeTestRule.setContent {
      ProfileScreen(currentUserId = testUser.userId, viewModel = viewModel)
    }

    composeTestRule.waitForIdle()
    composeTestRule.onNodeWithContentDescription("Location").assertIsDisplayed()
  }

  @Test
  fun profileScreen_handlesUserWithoutBio() {
    val userWithoutBio = testUser.copy(bio = null)
    mockUserRepository.user = userWithoutBio

    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId,
            eventRepository = TODO()
        )

    composeTestRule.setContent {
      ProfileScreen(currentUserId = testUser.userId, viewModel = viewModel)
    }

    composeTestRule.waitForIdle()

    // Should still display name and university
    composeTestRule.onNodeWithText("John Doe").assertIsDisplayed()
    composeTestRule.onNodeWithText("EPFL").assertIsDisplayed()
  }

  @Test
  fun profileScreen_handlesUserWithoutCountry() {
    val userWithoutCountry = testUser.copy(country = null)
    mockUserRepository.user = userWithoutCountry

    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId)

    composeTestRule.setContent {
      ProfileScreen(currentUserId = testUser.userId, viewModel = viewModel)
    }

    composeTestRule.waitForIdle()

    // Should still display name
    composeTestRule.onNodeWithText("John Doe").assertIsDisplayed()
    // Location icon should not be displayed
    composeTestRule.onNodeWithContentDescription("Location").assertDoesNotExist()
  }

  @Test
  fun profileScreen_displaysZeroFriends() {
    mockFriendsRepository.friendsList = emptyList()
    mockUserRepository.joinedEvents = listOf("event1") // Au moins 1 event pour différencier

    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId)

    composeTestRule.setContent {
      ProfileScreen(currentUserId = testUser.userId, viewModel = viewModel)
    }

    composeTestRule.waitForIdle()

    // Vérifier qu'il y a un "0" (pour friends) et "Friends" label
    composeTestRule.onNodeWithText("Friends").assertIsDisplayed()
    // Vérifier qu'il y a au moins un "0" affiché
    composeTestRule.onAllNodesWithText("0").assertCountEquals(1)
  }

  @Test
  fun profileScreen_displaysZeroEvents() {
    mockUserRepository.joinedEvents = emptyList()

    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId)

    composeTestRule.setContent {
      ProfileScreen(currentUserId = testUser.userId, viewModel = viewModel)
    }

    composeTestRule.waitForIdle()
    composeTestRule.onNodeWithText("0").assertIsDisplayed()
    composeTestRule.onNodeWithText("Events").assertIsDisplayed()
  }

  @Test
  fun profileScreen_isScrollable() {
    val viewModel =
        ProfileScreenViewModel(
            userRepository = mockUserRepository,
            friendsRepository = mockFriendsRepository,
            currentUserId = testUser.userId)

    composeTestRule.setContent {
      ProfileScreen(currentUserId = testUser.userId, viewModel = viewModel)
    }

    composeTestRule.waitForIdle()

    // Should be able to see all content
    composeTestRule.onNodeWithText("John Doe").assertIsDisplayed()
    composeTestRule.onNodeWithText("EPFL").assertIsDisplayed()
  }

  // Mock repositories
  private class MockUserRepository(var user: User?) : UserRepository {
    var joinedEvents: List<String> = emptyList()

    override suspend fun getUserById(userId: String): User? {
      delay(50)
      return user
    }

    override suspend fun getJoinedEvents(userId: String): List<String> = joinedEvents

    override suspend fun saveUser(user: User) = Unit

    override suspend fun leaveEvent(eventId: String, userId: String) = Unit

    override suspend fun getUserByEmail(email: String) = null

    override suspend fun getAllUsers() = emptyList<User>()

    override suspend fun getUsersPaginated(limit: Int, lastUserId: String?) =
        emptyList<User>() to false

    override suspend fun updateUser(userId: String, updates: Map<String, Any?>) = Unit

    override suspend fun deleteUser(userId: String) = Unit

    override suspend fun getUsersByUniversity(university: String) = emptyList<User>()

    override suspend fun getUsersByHobby(hobby: String) = emptyList<User>()

    override suspend fun getNewUid() = "new_uid"

    override suspend fun addEventToUser(eventId: String, userId: String) = Unit

    override suspend fun addInvitationToUser(eventId: String, userId: String, fromUserId: String) =
        Unit

    override suspend fun getInvitations(userId: String) = emptyList<Invitation>()

    override suspend fun acceptInvitation(eventId: String, userId: String) = Unit

    override suspend fun declineInvitation(eventId: String, userId: String) = Unit

    override suspend fun removeInvitation(eventId: String, userId: String) = Unit

    override suspend fun joinEvent(eventId: String, userId: String) = Unit

    override suspend fun sendInvitation(eventId: String, fromUserId: String, toUserId: String) =
        Unit

    override suspend fun addFavoriteEvent(userId: String, eventId: String) = Unit

    override suspend fun removeFavoriteEvent(userId: String, eventId: String) = Unit

    override suspend fun getFavoriteEvents(userId: String) = emptyList<String>()

    override suspend fun checkUsernameAvailability(username: String) = true

    override suspend fun addPinnedEvent(userId: String, eventId: String) = Unit

    override suspend fun removePinnedEvent(userId: String, eventId: String) = Unit

    override suspend fun getPinnedEvents(userId: String): List<String> = emptyList()
  }

  private class MockFriendsRepository(var friendsList: List<String>) : FriendsRepository {
    override suspend fun getFriends(userId: String): List<String> {
      delay(50)
      return friendsList
    }

    override suspend fun getPendingRequests(userId: String) = emptyList<String>()

    override suspend fun getSentRequests(userId: String) = emptyList<String>()

    override suspend fun sendFriendRequest(fromUserId: String, toUserId: String) = Unit

    override suspend fun acceptFriendRequest(userId: String, fromUserId: String) = Unit

    override suspend fun rejectFriendRequest(userId: String, fromUserId: String) = Unit

    override suspend fun cancelFriendRequest(userId: String, toUserId: String) = Unit

    override suspend fun removeFriend(userId: String, friendId: String) = Unit

    override suspend fun areFriends(userId: String, otherUserId: String) = false

    override suspend fun hasPendingRequest(fromUserId: String, toUserId: String) = false

    override fun observeFriendship(userId: String, otherUserId: String): Flow<Boolean> {
      TODO("Not yet implemented")
    }
  }

  private class MockEventRepository : com.github.se.studentconnect.model.event.EventRepository {
    override fun getNewUid(): String = "test-event-uid"

    override suspend fun getAllVisibleEvents(): List<com.github.se.studentconnect.model.event.Event> =
        emptyList()

    override suspend fun getAllVisibleEventsSatisfying(
        predicate: (com.github.se.studentconnect.model.event.Event) -> Boolean
    ): List<com.github.se.studentconnect.model.event.Event> = emptyList()

    override suspend fun getEvent(eventUid: String): com.github.se.studentconnect.model.event.Event =
        throw NotImplementedError()

    override suspend fun getEventParticipants(
        eventUid: String
    ): List<com.github.se.studentconnect.model.event.EventParticipant> = emptyList()

    override suspend fun addEvent(event: com.github.se.studentconnect.model.event.Event) {}

    override suspend fun editEvent(
        eventUid: String,
        newEvent: com.github.se.studentconnect.model.event.Event
    ) {}

    override suspend fun deleteEvent(eventUid: String) {}

    override suspend fun addParticipantToEvent(
        eventUid: String,
        participant: com.github.se.studentconnect.model.event.EventParticipant
    ) {}

    override suspend fun addInvitationToEvent(
        eventUid: String,
        invitedUser: String,
        currentUserId: String
    ) {}

    override suspend fun getEventInvitations(eventUid: String): List<String> = emptyList()

    override suspend fun removeInvitationFromEvent(
        eventUid: String,
        invitedUser: String,
        currentUserId: String
    ) {}

    override suspend fun removeParticipantFromEvent(eventUid: String, participantUid: String) {}
  }
}
